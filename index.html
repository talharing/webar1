<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>GPS AR Model Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.2.0/aframe.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            z-index: 999;
            display: flex;
            flex-direction: column;
        }
        
        #status {
            margin-bottom: 10px;
        }
        
        #distance {
            font-weight: bold;
        }
        
        #arView {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="overlay">
        <div id="status">Initializing...</div>
        <div id="location">Current location: Waiting for GPS...</div>
        <div id="distance">Distance to AR object: Calculating...</div>
    </div>
    
    <a-scene id="arView" embedded arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-assets>
            <!-- Define your model assets here -->
            <a-asset-item id="model1" src="https://cdn.aframe.io/examples/ar/models/CesiumMan/CesiumMan.gltf"></a-asset-item>
            <!-- Add more models as needed -->
        </a-assets>
        
        <!-- Camera with GPS capabilities -->
        <a-camera gps-projected-camera rotation-reader></a-camera>
    </a-scene>
    
    <script>
        // REPLACE THESE WITH YOUR ACTUAL MODEL COORDINATES AND DETAILS
        const modelConfigs = [
            {
                id: "model-landmark-1",
                lat: 37.7749, // Replace with your actual coordinates
                lng: -122.4194, // Replace with your actual coordinates
                scale: "0.5 0.5 0.5",
                modelUrl: "#model1", // Reference to the asset item above
                triggerDistance: 20 // meters
            },
            // Add more pre-defined models as needed
        ];
        
        // Variables to store user's current location
        let userLat = 0;
        let userLng = 0;
        
        // DOM elements
        const statusEl = document.getElementById('status');
        const locationEl = document.getElementById('location');
        const distanceEl = document.getElementById('distance');
        
        // Initialize the app
        function init() {
            statusEl.textContent = "Checking device capabilities...";
            
            // Check if device supports geolocation
            if ('geolocation' in navigator) {
                statusEl.textContent = "Device supports geolocation. Waiting for permission...";
                
                // Start tracking user's location
                navigator.geolocation.watchPosition(updatePosition, handleLocationError, {
                    enableHighAccuracy: true,
                    maximumAge: 0
                });
                
                // Check if device supports WebXR
                if ('xr' in navigator) {
                    navigator.xr.isSessionSupported('immersive-ar').then(supported => {
                        if (supported) {
                            statusEl.textContent = "AR and GPS capabilities detected!";
                        } else {
                            statusEl.textContent = "GPS available, but AR not fully supported on this device.";
                        }
                    });
                } else {
                    statusEl.textContent = "GPS available, but WebXR not supported. Using fallback AR.";
                }
            } else {
                statusEl.textContent = "ERROR: Geolocation is not supported by this device.";
            }
            
            // Create entities for all pre-defined models
            modelConfigs.forEach(createModelEntity);
            
            // Start checking distance to models regularly
            setInterval(checkDistanceToModels, 1000);
        }
        
        // Update user's position when GPS data is received
        function updatePosition(position) {
            userLat = position.coords.latitude;
            userLng = position.coords.longitude;
            
            locationEl.textContent = `Current location: ${userLat.toFixed(6)}, ${userLng.toFixed(6)}`;
            
            // Check distance to all models
            checkDistanceToModels();
        }
        
        // Handle geolocation errors
        function handleLocationError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    statusEl.textContent = "ERROR: Location permission denied. Please enable GPS.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    statusEl.textContent = "ERROR: Location information unavailable.";
                    break;
                case error.TIMEOUT:
                    statusEl.textContent = "ERROR: Location request timed out.";
                    break;
                default:
                    statusEl.textContent = "ERROR: An unknown error occurred.";
                    break;
            }
        }
        
        // Calculate distance between two GPS coordinates in meters (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            
            return R * c; // Distance in meters
        }
        
        // Check distance to all models and show/hide based on proximity
        function checkDistanceToModels() {
            if (userLat === 0 && userLng === 0) return; // No valid user location yet
            
            let closestDistance = Infinity;
            
            modelConfigs.forEach(model => {
                const distance = calculateDistance(userLat, userLng, model.lat, model.lng);
                
                // If model is within trigger distance, make it visible
                if (distance <= model.triggerDistance) {
                    // Get the entity for this model
                    const entity = document.getElementById(model.id);
                    
                    if (entity && !entity.getAttribute('visible')) {
                        entity.setAttribute('visible', true);
                        
                        // Calculate bearing to position model correctly
                        const bearing = calculateBearing(userLat, userLng, model.lat, model.lng);
                        
                        // Position the model in the appropriate direction
                        const distance3D = Math.min(distance, 10); // Cap the distance for better visualization
                        
                        // Convert polar coordinates (distance, bearing) to Cartesian
                        const x = distance3D * Math.sin(bearing * Math.PI / 180);
                        const z = -distance3D * Math.cos(bearing * Math.PI / 180);
                        
                        entity.setAttribute('position', `${x} 0 ${z}`);
                        statusEl.textContent = `AR model found nearby! (${model.id})`;
                    }
                } else {
                    // Hide model if too far
                    const entity = document.getElementById(model.id);
                    if (entity) {
                        entity.setAttribute('visible', false);
                    }
                }
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                }
            });
            
            // Update distance display
            distanceEl.textContent = `Distance to nearest AR object: ${closestDistance.toFixed(1)} meters`;
            
            // Change text color based on proximity
            if (closestDistance <= 20) {
                distanceEl.style.color = '#4CAF50'; // Green when close
            } else if (closestDistance <= 100) {
                distanceEl.style.color = '#FFC107'; // Yellow when medium distance
            } else {
                distanceEl.style.color = 'white'; // Default color when far
            }
        }
        
        // Calculate bearing between two GPS coordinates
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) -
                    Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            
            const θ = Math.atan2(y, x);
            
            return (θ * 180 / Math.PI + 360) % 360; // Bearing in degrees
        }
        
        // Create a new model entity
        function createModelEntity(modelConfig) {
            const scene = document.querySelector('a-scene');
            
            const entity = document.createElement('a-entity');
            entity.id = modelConfig.id;
            entity.setAttribute('gltf-model', modelConfig.modelUrl);
            entity.setAttribute('scale', modelConfig.scale);
            entity.setAttribute('visible', false);
            
            scene.appendChild(entity);
            
            return entity;
        }
        
        // Initialize the app when the page is loaded
        window.addEventListener('load', init);
    </script>
</body>
</html>
